{% extends "base.html" %}

{% block title %}训练历史记录 - 3DGS Web{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="welcome-section" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1><i class="fas fa-history"></i> 训练历史记录</h1>
            <p class="subtitle">查看所有的训练任务记录及相关文件下载</p>
        </div>
        <button class="btn-secondary" style="color: black;" onclick="window.location.href='/'">
            <i class="fas fa-arrow-left"></i> 返回主页
        </button>
    </div>

    <div class="feature-card" style="width: 100%; max-width: 100%;">
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>任务ID</th>
                        <th>场景名称 (Scene)</th>
                        <th>数据集 (Dataset)</th>
                        <th>训练模型 (Model)</th>
                        <th>评估报告 (Report)</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                    <tr>
                        <td colspan="5" style="text-align: center;">正在加载数据...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', async function() {
        const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
        
        if (!currentUser) {
            alert('请先登录');
            window.location.href = '/login';
            return;
        }

        try {
            const response = await fetch(`/api/history/list?username=${currentUser.username}`);
            const data = await response.json();
            
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';
            
            if (data.success && data.data.length > 0) {
                data.data.forEach(record => {
                    // 从路径中尝试提取场景名
                    let sceneName = 'Unknown';
                    if (record.train_model_path) {
                        const parts = record.train_model_path.split(/[/\\]/);
                        if (parts.length > 0) sceneName = parts[parts.length - 1];
                    }

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${record.task_id}</td>
                        <td>${sceneName}</td>
                        <td>
                            ${record.dataset_path ? 
                                `<a href="/api/history/download/dataset/${record.task_id}" class="btn-download" target="_blank">
                                    <i class="fas fa-download"></i> 下载数据集
                                </a>` : 
                                '<span class="text-muted">无</span>'}
                        </td>
                        <td>
                            ${record.train_model_path ? 
                                `<a href="/api/history/download/model/${record.task_id}" class="btn-download" target="_blank">
                                    <i class="fas fa-download"></i> 下载模型
                                </a>` : 
                                '<span class="text-muted">无</span>'}
                        </td>
                        <td>
                            ${record.eval_output_path ? 
                                `<a href="/api/history/download/eval/${record.task_id}" class="btn-download" target="_blank">
                                    <i class="fas fa-file-alt"></i> 下载报告
                                </a>` : 
                                '<span class="text-muted">未评估</span>'}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">暂无历史记录</td></tr>';
            }
        } catch (error) {
            console.error('Failed to load history:', error);
            document.getElementById('historyTableBody').innerHTML = 
                '<tr><td colspan="5" style="text-align: center; color: red;">加载失败，请重试</td></tr>';
        }
    });
</script>
{% endblock %}

{% block extra_css %}
<style>
    .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem 1.5rem;
    }
    
    .table-responsive {
        overflow-x: auto;
    }
    
    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }
    
    .data-table th, .data-table td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .data-table th {
        background-color: rgba(255, 255, 255, 0.05);
        color: var(--primary-color);
        font-weight: 600;
    }
    
    .data-table tr:hover {
        background-color: rgba(255, 255, 255, 0.02);
    }
    
    .btn-download {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.4rem 0.8rem;
        background-color: rgba(67, 97, 238, 0.1);
        color: var(--primary-color);
        border-radius: 4px;
        text-decoration: none;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }
    
    .btn-download:hover {
        background-color: var(--primary-color);
        color: white;
    }
    
    .text-muted {
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .btn-secondary {
        background-color: rgba(255, 255, 255, 0.1);
        color: white;
        border: none;
        padding: 0.6rem 1.2rem;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .btn-secondary:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }
</style>
{% endblock %}
